name: Rust CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  fmt:
    name: fmt
    if: "${{ !(github.event_name == 'push' && startsWith(github.event.head_commit.message, 'chore: prepare for')) }}"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/rust-setup
        with:
          toolchain: stable
          components: rustfmt
          cache-suffix: fmt
      - run: cargo fmt --check

  clippy:
    name: clippy
    if: "${{ !(github.event_name == 'push' && startsWith(github.event.head_commit.message, 'chore: prepare for')) }}"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/rust-setup
        with:
          toolchain: stable
          components: clippy
          cache-suffix: clippy
      - run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: test
    if: "${{ !(github.event_name == 'push' && startsWith(github.event.head_commit.message, 'chore: prepare for')) }}"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/rust-setup
        with:
          toolchain: stable
          cache-suffix: test
      - run: cargo test --workspace --all-features